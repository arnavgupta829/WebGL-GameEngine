function createID(){
    let ID = "";
    let chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890";
    for(let i = 0; i<10; i++){
        ID += chars.charAt(Math.floor(Math.random()*62));
    }
    return ID;
}

// Common Utility Functions 
let add = (a,b) => { let v = []; for (let i=0 ; i<a.length ; i++) v.push(a[i] + b[i]); return v; }
let subtract = (a,b) => { let v = []; for (let i=0 ; i<a.length ; i++) v.push(a[i] - b[i]); return v; }
let cross = (a,b) => [ a[1]*b[2] - a[2]*b[1], a[2]*b[0] - a[0]*b[2], a[0]*b[1] - a[1]*b[0] ];
let dot = (a,b) => { let s = 0 ; for (let i=0 ; i<a.length ; i++) s += a[i] * b[i]; return s; }
let norm = v => Math.sqrt(dot(v,v));
let normalize = v => { let s = norm(v); return v.length==3 ? [ v[0]/s,v[1]/s,v[2]/s ] : [ v[0]/s,v[1]/s ]; }
let resize = (v,s) => v.length==2 ? [ s*v[0], s*v[1] ] : [s*v[0], s*v[1], s*v[2] ];

let ik = (A,a,b,C,aim) => {
  C = [ C[0]-A[0], C[1]-A[1], C[2]-A[2] ];
  let dot = (A,B) => A[0]*B[0]+A[1]*B[1]+A[2]*B[2], B=[], D=[];
  let cc = dot(C,C), x = (1+(a*a-b*b)/cc)/2, c = dot(C,aim)/cc;
  for (let i = 0 ; i < 3 ; i++) D[i] = aim[i] - c * C[i];
  let y = Math.sqrt(Math.max(0, a*a - cc*x*x) / dot(D,D));
  for (let i = 0 ; i < 3 ; i++) B[i] = A[i] + x*C[i] + y*D[i];
  return B;
}

let ease = t => { t = Math.max(0, Math.min(1, t)); return t * t * (3 - t - t); }
let evalBezier = (B,t) => (1-t)*(1-t)*(1-t)*B[0] + 3*(1-t)*(1-t)*t*B[1] + 3*(1-t)*t*t*B[2] + t*t*t*B[3];
let mix = (a,b,t) => { let c = []; for (let i=0 ; i<a.length ; i++) c[i] = a[i] + t*(b[i]-a[i]); return c; }

let createMesh = (nu, nv, p) => {
  let mesh = [];
  for (let j = nv ; j > 0 ; j--) {
    for (let i = 0 ; i <= nu ; i++)
        mesh.push(p(i/nu,j/nv),p(i/nu,j/nv-1/nv));
    mesh.push(p(1,j/nv-1/nv),p(0,j/nv-1/nv));
  }
  return mesh.flat();
};

let Shape = {

  cube : () => {
      return [
        -1,-1,-1, 0, 0,-1, -1, 0, 0, 0, 1,  1,-1,-1, 0, 0,-1, -1, 0, 0, 0.5, 1,   1, 1,-1, 0, 0,-1, -1, 0, 0, 0.5, 0.5,
        1, 1,-1, 0, 0,-1,-1, 0, 0, 0.5, 0.5,   -1, 1,-1, 0, 0,-1,-1, 0, 0, 0, 0.5,  -1,-1,-1, 0, 0,-1,-1, 0, 0, 0, 1,
        -1,-1, 1, 0, 0, 1,-1, 0, 0, 0, 1,   1,-1, 1, 0, 0, 1,-1, 0, 0, 0.5, 1,  1, 1, 1, 0, 0, 1, -1, 0, 0, 0.5, 0.5,
        1, 1, 1, 0, 0, 1,-1, 0, 0, 0.5, 0.5,  -1, 1, 1, 0, 0, 1,-1, 0, 0, 0, 0.5,  -1,-1, 1, 0, 0, 1,-1, 0, 0, 0, 1,
        
        -1,-1,-1, 0,-1, 0, 1, 0, 0, 0, 0.5,  1,-1,-1, 0,-1, 0, 1, 0, 0,  0.5, 0.5,  1,-1, 1, 0,-1, 0, 1, 0, 0, 0.5, 0,
        1,-1, 1, 0,-1, 0, 1, 0, 0, 0.5, 0,  -1,-1, 1, 0,-1, 0, 1, 0, 0,  0, 0,      -1,-1,-1, 0,-1, 0, 1, 0, 0, 0, 0.5,
        -1, 1,-1, 0, 1, 0, 1, 0,0, 0.5, 0.5,  1, 1,-1, 0, 1, 0, 1, 0, 0, 1, 0.5,  1, 1, 1, 0, 1, 0, 1, 0, 0,  1, 1,
        1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1,  -1, 1, 1, 0, 1, 0, 1, 0, 0, 0.5, 1,  -1, 1,-1, 0, 1, 0, 1, 0, 0, 0.5, 0.5,

        -1, -1, -1, -1, 0, 0, 0, 1, 0, 1, 0.5,  -1, 1,-1,-1, 0, 0, 0, 1, 0, 1, 0,  -1, 1, 1,-1, 0, 0, 0, 1, 0, 0.5, 0,
        -1, 1, 1,-1, 0, 0, 0, 1, 0,  0.5, 0,  -1,-1, 1,-1, 0, 0,0, 1, 0,  0.5, 0.5,  -1,-1,-1,-1, 0, 0, 0, 1, 0, 1, 0.5,
        1,-1,-1, 1, 0, 0, 0, 1, 0,  1, 0.5,  1, 1,-1, 1, 0, 0, 0, 1, 0, 1, 0,      1, 1, 1, 1, 0, 0, 0, 1, 0, 0.5, 0,
        1, 1, 1, 1, 0, 0, 0, 1, 0,  0.5, 0,  1,-1, 1, 1, 0, 0, 0, 1, 0, 0.5, 0.5,  1,-1,-1, 1, 0, 0, 0, 1, 0, 1, 0.5
        ];
  },

  sphere : (nu, nv, hasTexture) => createMesh(nu,nv,(u,v) => {
    let theta = Math.PI * 2 * u,
        phi   = Math.PI * (v - .5),
        x = Math.cos(phi) * Math.cos(theta),
        y = Math.cos(phi) * Math.sin(theta),
        z = Math.sin(phi);

    return hasTexture??true 
      ? [x, y, z, x, y, z, -y, x, 0, u, v] 
      : [x, y, z, x, y, z];
  }),

  flat : (nu, nv, hasTexture) => createMesh(nu, nv, (u, v) => {
    return hasTexture??true 
      ? [2 * u - 1, 0, 2 * v - 1, 0, 1, 0, 1, 0, 0, 4 * u, 4 * v] 
      : [2 * u - 1, 0, 2 * v - 1,  0, 1, 0];
  }),

  tube : (nu, hasTexture) => createMesh(nu,2,(u,v) => {
    let theta = Math.PI * 2 * u,
        x = Math.cos(theta),
        y = Math.sin(theta),
        z = 2 * v - 1;
    return hasTexture??true 
      ? [x, y, z, x, y, 0, -y, x, 0, u, v]
      : [x, y, z, x, y, 0];
  }),

  skybox : () => {
    return [
      -1, -1,
      1, -1,
      -1,  1,
      -1,  1,
      1, -1,
      1,  1,
    ];
  }
};

async function getMesh (src) {
  const response = await fetch(src);
  const lines = await response.text();

  meshData = [];

  let lineArray = lines.split("\n");
  for (let i = 0; i < lineArray.length;  i++) {
    let points = lineArray[i].split(",").slice(0, -1);
    meshData.push(points);
  }

  return new Float32Array(meshData.flat());
}

let linefont = [
   { name: ' ', paths: [
   ] },
   { name: '!', paths: [
        [ [30,0],[30,75] ],
        [ [25,100],[35,100],[35,90],[25,90],[25,100] ],
   ] },
   { name: '"', paths: [
        [ [20,0],[20,30] ],
        [ [40,0],[40,30] ],
   ] },
   { name: '#', paths: [
        [ [25,10],[15,90] ],
        [ [45,10],[35,90] ],
        [ [0,40],[60,40] ],
        [ [0,60],[60,60] ],
   ] },
   { name: '$', paths: [
        [ [50,20],[10,20],[10,50],[50,50],[50,80],[10,80] ],
        [ [25,0],[25,100] ],
        [ [35,0],[35,100] ],
   ] },
   { name: '%', paths: [
        [ [60,10],[0,90] ],
        [ [ 5, 20],[15, 20],[15,10],[ 5,10],[ 5, 20] ],
        [ [45, 90],[55, 90],[55,80],[45,80],[45, 90] ],
   ] },
   { name: '&', paths: [
        [ [60,100],[0,20],[15,0],[35,0],[50,20],[0,70],[0,100],[30,100],[60,70] ],
   ] },
   { name: '\'', paths: [
        [ [35,0],[25,30] ],
   ] },
   { name: '(', paths: [
        [ [40,0],[20,30],[20,70],[40,100] ],
   ] },
   { name: ')', paths: [
        [ [20,0],[40,30],[40,70],[20,100] ],
   ] },
   { name: '*', paths: [
        [ [30,25],[30,75] ],
        [ [ 7,35],[53,65] ],
        [ [53,35],[ 7,65] ],
   ] },
   { name: '+', paths: [
        [ [10,60],[50,60] ],
        [ [30,40],[30,80] ],
   ] },
   { name: ',', paths: [
        [ [30,80],[30,100],[15,120] ],
   ] },
   { name: '-', paths: [
        [ [10,60],[50,60] ],
   ] },
   { name: '.', paths: [
        [ [25,100],[35,100],[35,90],[25,90],[25,100] ],
   ] },
   { name: '/', paths: [
        [ [50,0],[10,100] ],
   ] },
   { name: '0', paths: [
        [ [15,100],[0,85],[0,15],[15,0],[45,0],[60,15],[60,85],[45,100],[15,100] ],
   ] },
   { name: '1', paths: [
        [ [10,20],[30,0],[30,100] ],
   ] },
   { name: '2', paths: [
        [ [0,30],[0,15],[15,0],[45,0],[60,15],[60,35],[0,100],[60,100] ],
   ] },
   { name: '3', paths: [
        [ [0,15],[15,0],[45,0],[60,15],[60,35],[40,50],[60,65],[60,85],[45,100],[15,100],[0,85] ],
   ] },
   { name: '4', paths: [
        [ [60,60],[0,60],[40,0],[40,100] ],
   ] },
   { name: '5', paths: [
        [ [60,0],[5,0],[5,40],[45,40],[60,55],[60,85],[45,100],[15,100],[0,85] ],
   ] },
   { name: '6', paths: [
        [ [0,55],[15,45],[45,45],[60,60],[60,85],[45,100],[15,100],[0,85],[0,15],[15,0],[45,0],[60,15] ],
   ] },
   { name: '7', paths: [
        [ [0,0],[60,0],[20,100] ],
   ] },
   { name: '8', paths: [
        [ [30,50],[45,50],[60,65],[60,85],[45,100],[15,100],[0,85],[0,65],[15,50],[40,50],[55,35],[55,15],[40,0],[20,0],[5,15],[5,35],[20,50],[30,50] ],
   ] },
   { name: '9', paths: [
        [ [60,45],[45,55],[15,55],[0,40],[0,15],[15,0],[45,0],[60,15],[60,85],[45,100],[15,100],[0,85] ],
   ] },
   { name: ':', paths: [
        [ [25, 50],[35, 50],[35,40],[25,40],[25, 50] ],
        [ [25,100],[35,100],[35,90],[25,90],[25,100] ],
   ] },
   { name: ';', paths: [
        [ [25, 50],[35, 50],[35,40],[25,40],[25, 50] ],
        [ [30,80],[30,100],[15,120] ],
   ] },
   { name: '<', paths: [
        [ [50,30],[10,50],[50,70] ],
   ] },
   { name: '=', paths: [
        [ [10,38],[50,38] ],
        [ [10,62],[50,62] ],
   ] },
   { name: '>', paths: [
        [ [10,30],[50,50],[10,70] ],
   ] },
   { name: '?', paths: [
        [ [10,20],[10,0],[50,0],[50,40],[30,40],[30,60] ],
        [ [25,100],[35,100],[35,90],[25,90],[25,100] ],
   ] },
   { name: '0', paths: [
        [ [50,115],[15,115],[0,95],[0,30],[15,15],[45,15],[60,30],[60,85],[45,97],[25,97],[17,87],[17,40],[25,35],[45,35],[60,55] ],
   ] },
   { name: 'A', paths: [
        [ [0,100],[30,0],[60,100] ],
        [ [10,100*2/3],[50,100*2/3] ],
   ] },
   { name: 'B', paths: [
        [ [0,100],[0,50],[40,50],[55,65],[55,85],[40,100],[0,100] ],
        [ [0,50],[0,0],[35,0],[50,15],[50,35],[35,50] ],
   ] },
   { name: 'C', paths: [
        [ [60,100],[0,100],[0,0],[60,0] ],
   ] },
   { name: 'D', paths: [
        [ [0,100],[0,0],[40,0],[60,20],[60,80],[40,100],[0,100] ],
   ] },
   { name: 'E', paths: [
        [ [60,100],[0,100],[0,0],[60,0] ],
        [ [0,50],[40,50], ],
   ] },
   { name: 'F', paths: [
        [ [0,100],[0,0],[60,0] ],
        [ [0,50],[40,50], ],
   ] },
   { name: 'G', paths: [
        [ [30,50],[60,50],[60,100],[0,100],[0,0],[60,0] ],
   ] },
   { name: 'H', paths: [
        [ [0,0],[0,100] ],
        [ [60,0],[60,100] ],
        [ [0,50],[60,50] ],
   ] },
   { name: 'I', paths: [
        [ [30,0],[30,100] ],
        [ [10,0],[50,0] ],
        [ [10,100],[50,100] ],
   ] },
   { name: 'J', paths: [
        [ [0,60],[0,100],[60,100],[60,0] ],
   ] },
   { name: 'K', paths: [
        [ [0,0],[0,100] ],
        [ [60,0],[0,50],[60,100] ],
   ] },
   { name: 'L', paths: [
        [ [0,0],[0,100],[60,100] ],
   ] },
   { name: 'M', paths: [
        [ [0,100],[0,0],[30,50],[60,0],[60,100] ],
   ] },
   { name: 'N', paths: [
        [ [0,100],[0,0],[60,100],[60,0] ],
   ] },
   { name: 'O', paths: [
        [ [0,100],[0,0],[60,0],[60,100],[0,100] ],
   ] },
   { name: 'P', paths: [
        [ [0,100],[0,0],[60,0],[60,50],[0,50] ],
   ] },
   { name: 'Q', paths: [
        [ [0,100],[0,0],[60,0],[60,70],[30,100],[0,100] ],
        [ [30,70],[60,100] ],
   ] },
   { name: 'R', paths: [
        [ [0,100],[0,0],[35,0],[50,15],[50,35],[35,50] ],
        [ [0,50],[30,50],[60,100] ],
   ] },
   { name: 'S', paths: [
        [ [0,100],[60,100],[60,50],[0,50],[0,0],[60,0] ],
   ] },
   { name: 'T', paths: [
        [ [30,0],[30,100] ],
        [ [0,0],[60,0] ],
   ] },
   { name: 'U', paths: [
        [ [0,0],[0,100],[60,100],[60,0] ],
   ] },
   { name: 'V', paths: [
        [ [0,0],[30,100],[60,0] ],
   ] },
   { name: 'W', paths: [
        [ [0,0],[10,100],[30,50],[50,100],[60,0] ],
   ] },
   { name: 'X', paths: [
        [ [0,0],[60,100] ],
        [ [60,0],[0,100] ],
   ] },
   { name: 'Y', paths: [
        [ [0,0],[30,50],[60,0] ],
        [ [30,50],[30,100] ],
   ] },
   { name: 'Z', paths: [
        [ [0,0],[60,0],[0,100],[60,100] ],
   ] },
   { name: '[', paths: [
        [ [40,0],[20,0],[20,100],[40,100] ],
   ] },
   { name: '\\', paths: [
        [ [10,0],[50,100] ],
   ] },
   { name: ']', paths: [
        [ [20,0],[40,0],[40,100],[20,100] ],
   ] },
   { name: '^', paths: [
        [ [10,30],[30,0],[50,30] ],
   ] },
   { name: '_', paths: [
        [ [0,100],[60,100] ],
   ] },
   { name: '`', paths: [
        [ [25,0],[35,25] ],
   ] },
   { name: 'a', paths: [
        [ [50,75],[30,100],[10,100],[10,50],[50,50],[50,100] ],
   ] },
   { name: 'b', paths: [
        [ [10,0],[10,100],[50,100],[50,50],[10,50] ],
   ] },
   { name: 'c', paths: [
        [ [50,50],[10,50],[10,100],[50,100] ],
   ] },
   { name: 'd', paths: [
        [ [50,0],[50,100],[10,100],[10,50],[50,50] ],
   ] },
   { name: 'e', paths: [
        [ [10,75],[50,75],[50,50],[10,50],[10,100],[50,100] ],
   ] },
   { name: 'f', paths: [
        [ [50,0],[30,0],[30,100] ],
        [ [10,50],[50,50] ],
   ] },
   { name: 'g', paths: [
        [ [50,100],[10,100],[10,50],[50,50],[50,125],[10,125] ],
   ] },
   { name: 'h', paths: [
        [ [10,0],[10,100] ],
        [ [10,50],[50,50],[50,100] ],
   ] },
   { name: 'i', paths: [
        [ [30,50],[30,100] ],
        [ [25,20],[35,20],[35,10],[25,10],[25,20] ],
   ] },
   { name: 'j', paths: [
        [ [50,50],[50,125],[10,125],[10,100] ],
        [ [45,20],[55,20],[55,10],[45,10],[45,20] ],
   ] },
   { name: 'k', paths: [
        [ [10,0],[10,100] ],
        [ [50,50],[10,75],[50,100] ],
   ] },
   { name: 'l', paths: [
        [ [20,0],[30,0],[30,100],[40,100] ],
   ] },
   { name: 'n', paths: [
        [ [0,100],[0,50],[15,50],[30,75],[45,50],[60,50],[60,100] ],
   ] },
   { name: 'n', paths: [
        [ [10,100],[10,50] ],
        [ [10,75],[30,50],[50,50],[50,100] ],
   ] },
   { name: 'o', paths: [
        [ [50,50],[10,50],[10,100],[50,100],[50,50] ],
   ] },
   { name: 'p', paths: [
        [ [10,100],[50,100],[50,50],[10,50],[10,125] ],
   ] },
   { name: 'q', paths: [
        [ [50,100],[10,100],[10,50],[50,50],[50,125],[60,125] ],
   ] },
   { name: 'r', paths: [
        [ [10,100],[10,50] ],
        [ [10,75],[30,50],[50,50] ],
   ] },
   { name: 's', paths: [
        [ [50,50],[10,50],[10,75],[50,75],[50,100],[10,100] ],
   ] },
   { name: 't', paths: [
        [ [30,25],[30,100],[50,100] ],
        [ [10,50],[50,50] ],
   ] },
   { name: 'u', paths: [
        [ [50,50],[50,100] ],
        [ [50,75],[30,100],[10,100],[10,50] ],
   ] },
   { name: 'v', paths: [
        [ [10,50],[30,100],[50,50] ],
   ] },
   { name: 'w', paths: [
        [ [0,50],[15,100],[30,50],[45,100],[60,50] ],
   ] },
   { name: 'x', paths: [
        [ [10,50],[50,100] ],
        [ [50,50],[10,100] ],
   ] },
   { name: 'y', paths: [
        [ [10,50],[30,100] ],
        [ [20,125],[50,50] ],
   ] },
   { name: 'z', paths: [
        [ [10,50],[50,50],[10,100],[50,100] ],
   ] },
   { name: '{', paths: [
        [ [40,0],[20,10],[20,40],[10,50],[20,60],[20,90],[40,100] ],
   ] },
   { name: '|', paths: [
        [ [30,0],[30,100] ],
   ] },
   { name: '}', paths: [
        [ [20,0],[40,10],[40,40],[50,50],[40,60],[40,90],[20,100] ],
   ] },
   { name: '~', paths: [
        [ [0,55],[20,45],[40,55],[60,45] ],
   ] },
];

   let createPathsMesh = (lineWidth, paths) => {
      let vertices = [];
      let addVertex = pos => vertices.push(pos,[0,0,1]);
      for (let n = 0 ; n < paths.length ; n++) {
         let path = paths[n];
         for (let i = 0 ; i < path.length-1 ; i++) {
            let b = path[i  ];
            let c = path[i+1];
            let a = i>0 ? path[i-1] : add(b,subtract(b,c));
            let da = normalize(subtract(b, a));
            let dc = normalize(subtract(c, b));
            let db = normalize(add(da, dc));
            let s = dot(da, db);
            da = resize(da, lineWidth/2);
            dc = resize(dc, lineWidth/2);
            db = resize(db, lineWidth/2);
            let ea = [-da[1]  , da[0]  , 0];
            let ec = [-dc[1]  , dc[0]  , 0];
            let eb = [-db[1]/s, db[0]/s, 0];
            if (i == 0)
               b = subtract(b, da);
            if (dot(da, dc) < 0) {
               if (n > 0 && i == 0)
                  addVertex(subtract(b, ea));
               addVertex(subtract(b, ea));
               addVertex(add(b, ea));
               addVertex(subtract(b, ec));
               addVertex(add(b, ec));
            }
            else {
               if (n > 0 && i == 0)
                  addVertex(subtract(b, eb));
               addVertex(subtract(b, eb));
               addVertex(add(b, eb));
            }
            if (i == path.length-2) {
               addVertex(subtract(add(c, dc), ec));
               addVertex(add(add(c, dc), ec));
            }
            if (n < paths.length-1 && i == path.length-2)
               addVertex(add(add(c, dc), ec));
         }
      }
      return {
         triangle_strip: true,
	 data: new Float32Array(vertices.flat())
      }
   }

   let createTextMesh = text => {
      let myPaths = [], lines = text.split('\n'), c;
      for (let row = 0 ; row < lines.length ; row++)
      for (let col = 0 ; col < lines[row].length ; col++)
         if ((c=lines[row].charCodeAt(col) & 127) > 32) {
            let x = .019*col, y = -.0375*row;
            let paths = linefont[c - 32].paths;
            for (let i = 0 ; i < paths.length ; i++) {
               let myPath = [], path = paths[i];
               for (let j = 0 ; j < path.length ; j++) {
	            let p = path[j];
                  myPath.push([ x + p[0] / 4000,
                                y - p[1] / 4000, 0]);
               }
               myPaths.push(myPath);
            }
         }
      return createPathsMesh(.0025, myPaths);
   }